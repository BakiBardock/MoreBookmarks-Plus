demand_conversion_interaction = {
	icon = religious
	category = interaction_category_religion
	popup_on_receive = yes
	pause_on_receive = yes

	notification_text = HOUSE_HEAD_DEMAND_CONVERSION

	is_shown = {
		NOT = { scope:recipient = scope:actor }
		scope:actor = {
			is_house_head = yes
			NOT = { faith = scope:recipient.faith }
			house = scope:recipient.house
		}
		NOT = {
			scope:recipient = { # Use the vassal-liege interaction instead.
				is_ruler = yes
				target_is_liege_or_above = scope:actor
			}
		}
		scope:recipient = { # To avoid you converting someone's entire family, and then asking them. Restricting it to landed rulers at least gives them a chance to create their own cadet house.
			is_ruler = yes
		}
	}
	desc = {
		desc = demand_conversion_interaction_desc
		triggered_desc = {
			trigger = {
				scope:actor = {
					refusing_conversion_is_crime_trigger = {
						CHARACTER = scope:recipient
					}
				}
				scope:recipient = {
					target_is_liege_or_above = scope:actor
				}
			}
			desc = demand_conversion_vassal_ruler_is_crime
		}
	}

	is_valid_showing_failures_only = {
		valid_demand_conversion_conditions_trigger = yes
		OR = {
			AND = {
				scope:actor.faith = { has_doctrine = special_doctrine_catholic_communion }
				scope:recipient.faith = { has_doctrine = special_doctrine_catholic_communion }
				NOT = {
					scope:actor = { has_trait = zealous }
				}
			}
			AND = {
				scope:actor.faith = { has_doctrine = special_doctrine_orthodox_communion }
				OR = {
					scope:recipient.faith = { has_doctrine = special_doctrine_autocephaly }
					scope:recipient.faith = { has_doctrine = special_doctrine_pentarch }
				} 
				NOT = {
					scope:actor = { has_trait = zealous }
				}
			}
			AND = {
				scope:actor.faith = { has_doctrine = special_doctrine_oriental_communion }
				scope:recipient.faith = { has_doctrine = special_doctrine_oriental_communion }
				NOT = {
					scope:actor = { has_trait = zealous }
				}
			}
		}
	}
	
	on_accept = {
		demand_conversion_interaction_effect = yes
		if = {
			limit = { scope:hook = yes }
			scope:actor = {
				use_hook = scope:recipient
			}
			scope:recipient = {
				trigger_event = char_interaction.0180
			}
		}
		if = {
			limit = { scope:recipient = { is_imprisoned_by = scope:actor } }
			scope:recipient = { release_from_prison = yes }
			scope:recipient = {
				trigger_event = char_interaction.0180
			}
		}
		else = {
			scope:actor = {
				trigger_event = char_interaction.0181
			}
		}
	}

	on_decline = {
		scope:recipient = {
			execute_decision = create_cadet_branch_decision
			show_as_tooltip = { create_cadet_branch = yes }
		}
		#Negative opinions
		scope:recipient = {
			if = {
				limit = {
					scope:actor = {
						refusing_conversion_is_crime_trigger = {
							CHARACTER = scope:recipient
						}
					}
					scope:recipient = {
						target_is_liege_or_above = scope:actor
					}
				}
				add_opinion = {
					target = scope:recipient
					modifier = illegal_resisted_conversion_opinion
					years = 10
				}
			}
			else = {
				add_opinion = {
					modifier = demanded_my_conversion_opinion
					target = scope:actor
					opinion = -10
				}
			}
		}
		scope:actor = {
			trigger_event = char_interaction.0182
		}
	}

	auto_accept = {
		custom_description = {
			text = "spending_hook"
			subject = scope:actor
			object = scope:recipient
			scope:hook = yes
			scope:actor = { has_strong_hook = scope:recipient }
		}
	}
	
	ai_accept = {
		base = 0
		modifier = {
			add = 100
			NOT = {
				scope:recipient = {
					can_execute_decision = create_cadet_branch_decision
				}
			}
			desc = ASK_FOR_CONVERSION_CAN_NOT_CREATE_CADET_BRANCH
		}
		modifier = {
			add = -10
			scope:recipient = {
				can_execute_decision = create_cadet_branch_decision
			}
			desc = ASK_FOR_CONVERSION_CAN_CREATE_CADET_BRANCH
		}
		religion_demand_conversion_default_modifier = yes
	}
	
	can_send_despite_rejection = yes
	force_notification = yes

	#Use hook
	send_option = {
		is_valid = {
			scope:actor = {
				has_usable_hook = scope:recipient
			}
			NOT = {
				scope:recipient = { is_imprisoned_by = scope:actor }
			}
		}
		flag = hook
		localization = SCHEME_HOOK
	}
	should_use_extra_icon = {
		scope:actor = { has_usable_hook = scope:recipient }
	}
	extra_icon = "gfx/interface/icons/character_interactions/hook_icon.dds"

	send_options_exclusive = no
}


demand_conversion_vassal_ruler_interaction = {
	category = interaction_category_religion
	icon = religious

	ai_maybe = yes
	ai_min_reply_days = 4
	ai_max_reply_days = 9
	can_send_despite_rejection = yes
	ai_accept_negotiation = yes
	popup_on_receive = yes

	ai_targets = {
		ai_recipients = vassals
	}
	ai_target_quick_trigger = {
		adult = yes
	}
	ai_frequency = 12

	desc = {
		desc = ask_for_conversion_interaction_desc
		desc = line_break
		triggered_desc = {
			trigger = {
				NOT = { scope:recipient = { is_imprisoned_by = scope:actor } }
			}
			desc = might_ask_for_something_in_return_warning
		}
		triggered_desc = {
			trigger = {
				scope:actor = {
					refusing_conversion_is_crime_trigger = {
						CHARACTER = scope:recipient
					}
				}
			}
			desc = demand_conversion_vassal_ruler_is_crime
		}
	}

	on_decline_summary = stop_attacker_vassal_war_decline_summary

	is_shown = {
		scope:recipient = {
			target_is_liege_or_above = scope:actor
			NOT = { faith = scope:actor.faith }
			is_ai = yes
			is_ruler = yes
		}
	}

	cooldown_against_recipient = { years = 15 }

	is_valid_showing_failures_only = {
		valid_demand_conversion_conditions_trigger = yes
		OR = {
			AND = {
				scope:actor.faith = { has_doctrine = special_doctrine_catholic_communion }
				scope:recipient.faith = { has_doctrine = special_doctrine_catholic_communion }
				NOT = {
					scope:actor = { has_trait = zealous }
				}
			}
			AND = {
				scope:actor.faith = { has_doctrine = special_doctrine_orthodox_communion }
				OR = {
					scope:recipient.faith = { has_doctrine = special_doctrine_autocephaly }
					scope:recipient.faith = { has_doctrine = special_doctrine_pentarch }
				} 
				NOT = {
					scope:actor = { has_trait = zealous }
				}
			}
			AND = {
				scope:actor.faith = { has_doctrine = special_doctrine_oriental_communion }
				scope:recipient.faith = { has_doctrine = special_doctrine_oriental_communion }
				NOT = {
					scope:actor = { has_trait = zealous }
				}
			}
		}
	}

	auto_accept = {
		custom_description = {
			text = "spending_hook"
			subject = scope:actor
			object = scope:recipient
			scope:hook = yes
			scope:actor = { has_strong_hook = scope:recipient }
		}
	}

	on_send = {
	}


	on_accept = {
		scope:actor = {
			trigger_event = religious_interaction.2002
		}
		demand_conversion_vassal_ruler_interaction_effect = yes
	}

	on_decline = {
		scope:recipient = {
			hidden_effect = {
				random_list = {
					80 = { # Conditional acceptance
						modifier = {
							factor = 0 # Heresiarchs never agree to convert
							scope:recipient = {
								has_trait = heresiarch
							}
						}
						ai_value_modifier = {
							ai_greed = 0.5
						}
						random_list = {
							50 = { #They ask for gold
								modifier = {
									add = 50 # More likely to ask for gold if they're poor
									scope:recipient.short_term_gold < medium_gold_value
								}
								modifier = {
									add = { # Much more likely to ask for gold involved in one of their own wars (they want to win).
										value = 50
										if = {
											# Especially true if they're in debt!
											limit = { gold < 0 }
											add = 150
										}
									}									
									is_at_war = yes
									any_character_war = {
										is_war_leader = scope:recipient
									}
								}
								scope:actor = {
									trigger_event = {
										id = religious_interaction.2011
									}
								}
							}
							500 = { #They ask for a favor
								trigger = {
									exists = scope:recipient.capital_county
									NOT = { has_hook = scope:actor }
								}
								# Direct feudal vassals appreciate favors more (they can improve their contract).
								modifier = {
									add = {
										value = 50
										# This goes double for your Powerful Vassals. A better contract is likely to be much more important than a short-term payout.
										if = {
											limit = { is_powerful_vassal_of = scope:actor }
											add = 100
										}
									}
									this.liege = scope:actor
									government_has_flag = government_is_feudal
								}
								scope:actor = {
									trigger_event = {
										id = religious_interaction.2012
									}
								}
							}
						}

					}
					20 = { # Full refuse
						modifier = {
							add = 20
							scope:recipient.demand_conversion_likelihood_calculation < 40
						}
						modifier = {
							add = 20
							scope:recipient.demand_conversion_likelihood_calculation < 20
						}
						modifier = {
							add = 50
							scope:recipient.demand_conversion_likelihood_calculation < 0
						}
						scope:actor = {
							trigger_event = {
								id = religious_interaction.2003
							}
						}
					}
				}
			}
			custom_tooltip = demand_conversion_vassal_ruler_does_not_convert
			show_as_tooltip = {
				#Negative opinions
				add_opinion = {
					modifier = demanded_my_conversion_opinion
					target = scope:actor
					opinion = -10
				}
				scope:actor = {
					if = {
						limit = {
							refusing_conversion_is_crime_trigger = {
								CHARACTER = scope:recipient
							}
						}
						custom_tooltip = action_can_lawfully_imprison_label
					}
				}
			}
		}
	}
	
	ai_potential = {
		is_adult = yes
	}
	
	# Use hook
	send_option = {
		is_valid = {
			scope:actor = {
				has_usable_hook = scope:recipient
			}
			NOT = {
				scope:recipient = { is_imprisoned_by = scope:actor }
			}
		}
		flag = hook
		localization = SCHEME_HOOK
	}
	should_use_extra_icon = {
		scope:actor = { has_usable_hook = scope:recipient }
	}
	extra_icon = "gfx/interface/icons/character_interactions/hook_icon.dds"

	send_options_exclusive = no

	ai_will_do = {
		base = 100
		
		modifier = { # Make sure the AI uses hooks for this as it's % based
			scope:hook = yes
			add = 1
		}
		
		modifier = {
			factor = 0
			scope:recipient.demand_conversion_likelihood_calculation < 10
			NOT = {
				scope:actor = {
					refusing_conversion_is_crime_trigger = {
						CHARACTER = scope:recipient
					}
				}
			}
		}
		
		modifier = {
			factor = 0
			scope:recipient.demand_conversion_likelihood_calculation < 70
			scope:actor = {
				gold < demand_conversion_bribe_size
			}
		}

		modifier = {
			factor = 0
			scope:recipient.demand_conversion_likelihood_calculation < 90
			scope:actor = {
				culture = {
					has_cultural_parameter = less_likely_to_force_conversion
				}
			}
		}

		modifier = { # Do not convert Righteous faith subjects, unless disturbingly zealous
			factor = 0
			scope:actor = {
				ai_zeal < 100
				faith = {
					faith_hostility_level = {
						target = scope:recipient.faith
						value <= faith_fully_accepted_level
					}
				}
			}
			NOT = { # If the subject has one of your holy sites, always try to convert
				scope:recipient = {
					any_sub_realm_county = {
						any_county_province = {
							barony = {
								is_holy_site_of = scope:actor.faith
							}
						}
					}
				}
			}
			NOT = {
				scope:recipient = {
					is_close_family_of = scope:actor
				}
			}
		}

		modifier = { # Astray faiths require specific circumstances to demand conversion of
			factor = 0
			scope:actor = {
				has_tolerant_faith_or_culture_trigger = yes
				ai_zeal < 50
				faith = {
					faith_hostility_level = {
						target = scope:recipient.faith
						value <= faith_astray_level
					}
				}
			}
			NOT = { # If the subject has one of your holy sites, always try to convert
				scope:recipient = {
					any_sub_realm_county = {
						any_county_province = {
							barony = {
								is_holy_site_of = scope:actor.faith
							}
						}
					}
				}
			}
			NOT = {
				scope:recipient = {
					is_close_family_of = scope:actor
				}
			}
		}

		modifier = { # Astray faiths require specific circumstances to demand conversion of
			factor = 0
			scope:actor = {
				faith = { has_doctrine = doctrine_pluralism_fundamentalist }
				ai_zeal < -10
				faith = {
					faith_hostility_level = {
						target = scope:recipient.faith
						value <= faith_astray_level
					}
				}
			}
			NOT = { # If the subject has one of your holy sites, always try to convert
				scope:recipient = {
					any_sub_realm_county = {
						any_county_province = {
							barony = {
								is_holy_site_of = scope:actor.faith
							}
						}
					}
				}
			}
			NOT = {
				scope:recipient = {
					is_close_family_of = scope:actor
				}
			}
		}

		modifier = { # Astray faiths require specific circumstances to demand conversion of
			factor = 0
			scope:actor = {
				NOR = {
					faith = { has_doctrine = doctrine_pluralism_fundamentalist }
					has_tolerant_faith_or_culture_trigger = yes
				}
				ai_zeal < 0
				faith = {
					faith_hostility_level = {
						target = scope:recipient.faith
						value <= faith_astray_level
					}
				}
			}
			NOT = { # If the subject has one of your holy sites, always try to convert
				scope:recipient = {
					any_sub_realm_county = {
						any_county_province = {
							barony = {
								is_holy_site_of = scope:actor.faith
							}
						}
					}
				}
			}
		}
	}
	ai_accept = {
		base = 0
		religion_demand_conversion_default_modifier = yes

		modifier = {
			desc = might_ask_for_something_in_return_warning_line_break
			add = 0
		}
	}
}

demand_conversion_player_ruler_interaction = {
	category = interaction_category_religion
	desc = ask_for_conversion_interaction_desc
	notification_text = LIEGE_DEMAND_CONVERSION
	popup_on_receive = yes
	pause_on_receive = yes
	icon = religious
	
	ai_targets = {
		ai_recipients = vassals
	}
	ai_target_quick_trigger = {
		adult = yes
	}
	ai_frequency = 120

	is_shown = {
		scope:recipient = {
			is_ai = no
			target_is_liege_or_above = scope:actor
			NOT = { faith = scope:actor.faith }
		}
	}

	is_valid_showing_failures_only = {
		valid_demand_conversion_conditions_trigger = yes
		OR = {
			AND = {
				scope:actor.faith = { has_doctrine = special_doctrine_catholic_communion }
				scope:recipient.faith = { has_doctrine = special_doctrine_catholic_communion }
				NOT = {
					scope:actor = { has_trait = zealous }
				}
			}
			AND = {
				scope:actor.faith = { has_doctrine = special_doctrine_orthodox_communion }
				OR = {
					scope:recipient.faith = { has_doctrine = special_doctrine_autocephaly }
					scope:recipient.faith = { has_doctrine = special_doctrine_pentarch }
				} 
				NOT = {
					scope:actor = { has_trait = zealous }
				}
			}
			AND = {
				scope:actor.faith = { has_doctrine = special_doctrine_oriental_communion }
				scope:recipient.faith = { has_doctrine = special_doctrine_oriental_communion }
				NOT = {
					scope:actor = { has_trait = zealous }
				}
			}
		}
	}

	send_option = {
		is_valid = {
			scope:actor = {
				has_strong_usable_hook = scope:recipient
			}
		}
		flag = demand_conversion_hook
		localization = GENERIC_SPEND_A_HOOK
	}
	should_use_extra_icon = {
		scope:actor = { has_strong_usable_hook = scope:recipient }
	}
	extra_icon = "gfx/interface/icons/character_interactions/hook_icon.dds"


	send_options_exclusive = no

	auto_accept = {
		custom_description = {
			text = "spending_hook"
			subject = scope:actor
			object = scope:recipient
			scope:demand_conversion_hook = yes
		}
	}

	on_auto_accept = {
		demand_conversion_player_ruler_interaction_effect = yes

		scope:actor = {
			trigger_event = char_interaction.0190
		}
	
		scope:recipient = {
			trigger_event = religious_interaction.2021
		}
	}

	on_accept = {
		# Do conversion
		demand_conversion_player_ruler_interaction_effect = yes
		scope:actor = {
			trigger_event = char_interaction.0190
		}
	}

	on_decline = {
		scope:actor = {
			#Crime if relevant
			if = {
				limit = {
					refusing_conversion_is_crime_trigger = {
						CHARACTER = scope:recipient
					}
				}
				add_opinion = {
					target = scope:recipient
					modifier = illegal_resisted_conversion_opinion
					years = 15
				}
			}
			else = {
				add_opinion = {
					target = scope:recipient
					modifier = resisted_conversion_opinion
					years = 15
				}
			}
			trigger_event = char_interaction.0191
		}
	}
	
	ai_potential = {
		is_adult = yes
	}
	
	ai_will_do = {
		base = 100
		
		modifier = {
			scope:hook = yes
			add = 1
		}
		
		modifier = {
			factor = 0
			scope:recipient.demand_conversion_likelihood_calculation < 10
		}
		
		modifier = { # Do not convert Righteous faith subjects, unless disturbingly zealous
			factor = 0
			scope:actor = {
				ai_zeal < 100
				faith = {
					faith_hostility_level = {
						target = scope:recipient.faith
						value <= faith_fully_accepted_level
					}
				}
			}
			NOT = { # If the subject has one of your holy sites, always try to convert
				scope:recipient = {
					any_sub_realm_county = {
						any_county_province = {
							barony = {
								is_holy_site_of = scope:actor.faith
							}
						}
					}
				}
			}
			NOT = {
				scope:recipient = {
					is_close_family_of = scope:actor
				}
			}
		}

		modifier = { # Astray faiths require specific circumstances to demand conversion of
			factor = 0
			scope:actor = {
				has_tolerant_faith_or_culture_trigger = yes
				ai_zeal < 50
				faith = {
					faith_hostility_level = {
						target = scope:recipient.faith
						value <= faith_astray_level
					}
				}
			}
			NOT = { # If the subject has one of your holy sites, always try to convert
				scope:recipient = {
					any_sub_realm_county = {
						any_county_province = {
							barony = {
								is_holy_site_of = scope:actor.faith
							}
						}
					}
				}
			}
			NOT = {
				scope:recipient = {
					is_close_family_of = scope:actor
				}
			}
		}

		modifier = { # Astray faiths require specific circumstances to demand conversion of
			factor = 0
			scope:actor = {
				faith = { has_doctrine = doctrine_pluralism_fundamentalist }
				ai_zeal < -10
				faith = {
					faith_hostility_level = {
						target = scope:recipient.faith
						value <= faith_astray_level
					}
				}
			}
			NOT = { # If the subject has one of your holy sites, always try to convert
				scope:recipient = {
					any_sub_realm_county = {
						any_county_province = {
							barony = {
								is_holy_site_of = scope:actor.faith
							}
						}
					}
				}
			}
			NOT = {
				scope:recipient = {
					is_close_family_of = scope:actor
				}
			}
		}

		modifier = { # Astray faiths require specific circumstances to demand conversion of
			factor = 0
			scope:actor = {
				NOR = {
					faith = { has_doctrine = doctrine_pluralism_fundamentalist }
					has_tolerant_faith_or_culture_trigger = yes
				}
				ai_zeal < 0
				faith = {
					faith_hostility_level = {
						target = scope:recipient.faith
						value <= faith_astray_level
					}
				}
			}
			NOT = { # If the subject has one of your holy sites, always try to convert
				scope:recipient = {
					any_sub_realm_county = {
						any_county_province = {
							barony = {
								is_holy_site_of = scope:actor.faith
							}
						}
					}
				}
			}
			NOT = {
				scope:recipient = {
					is_close_family_of = scope:actor
				}
			}
		}
	}
}